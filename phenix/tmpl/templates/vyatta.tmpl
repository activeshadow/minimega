{{ $ntpAddr := index . "ntp-addr" }}
{{ $node := index . "node" }}

interfaces {
{{ range $idx, $iface := $node.Network.Interfaces }}
    ethernet eth{{ $idx }} {
        address {{ $iface.Address }}/{{ $iface.Mask }}
        duplex auto
        mtu {{ $iface.MTU }}
        {{ if eq $iface.Proto "OSPF" }}
        ip {
            ospf {
                dead-interval {{ $node.Network.OSPF.DeadInterval }}
                hello-interval {{ $node.Network.OSPF.HelloInterval }}
                retransmit-interval {{ $node.Network.OSPF.RetransInterval }}
                transmit-delay 1
            }
        }
        {{ end }}
        {{ if or (ne $iface.RulesetIn "") (ne $iface.RulesetOut "") }}
        firewall {
            {{ if ne $iface.RulesetIn "" }}
            in {
                name {{ $iface.RulesetIn }}
            }
            {{ end }}

            {{ if ne $iface.RulesetOut "" }}
            out {
                name {{ $iface.RulesetOut }}
            }
            {{ end }}
        }
        {{ end }}
    }
{{ end }}
}

firewall {
{{ range $node.Network.Rulesets }}
    {{ if ne .Default "" }}
    name {{ .Name }} {
        default-action {{ .Default }}
        {{ if ne .Description "" }}
        description "{{ .Description }}"
        {{ end }}
        {{ range .Rules }}
        rule {{ .ID }} {
            action {{ .Action }}
            {{ if ne .Description "" }}
            description "{{ .Description }}"
            {{ end }}
            protocol {{ .Protocol }}
            {{ if ne .Source nil }}
            source {
                {{ if ne .Source.Address "" }}
                address {{ .Source.Address }}
                {{ end }}
                {{ if ne .Source.Port 0 }}
                port {{ .Source.Port }}
                {{ end }}
            }
            {{ end }}
            {{ if ne .Destination nil }}
            destination {
                {{ if ne .Destination.Address "" }}
                address {{ .Destination.Address }}
                {{ end }}
                {{ if ne .Destination.Port 0 }}
                port {{ .Destination.Port }}
                {{ end }}
            }
            {{ end }}
        }
        {{ end }}
    }
    {{ end }}
{{ end }}
}

protocols {
    static {
{{ range $route := $node.Network.Routes }}
        route {{ $route.Destination }} {
            next-hop {{ $route.Next }} {
                distance {{ $route.Cost }}
            }
        }
{{ end }}
    }

    ospf {
{{ if ne $node.Network.OSPF nil }}
    {{ range $areas := $node.Network.OSPF.Areas }}
        area {{ $areas.AreaID }} {
        {{ range $areas.AreaNetworks }}
            network {{ $areas.AreaNetwork.Network }}
        {{ end }}
        }
    {{ end }}
        parameters {
    {{ if ne $node.Network.OSPF.RouterID "" }}
            router-id {{ $node.Network.OSPF.RouterID }}
    {{ end }}
        }
        redistribute {
            {{/* TODO: add redistribution stuff to OSPF schema definition */}}
        }
{{ end }}
    }

    bgp {
        {{/* TODO: add BGP stuff to Network schema definition */}}
    }
}

{{/* TODO: need to add Ipsec VPN content */}}

system {
    host-name {{ $node.RouterName }}
{{ if ne $ntpAddr "" }}
    ntp {
        server {{ $ntpAddr }} {
            perfer
        }
    }
{{ end }}
}
/* Warning: Do not remove the following line. */
/* === vyatta-config-version: "dhcp-relay@1:vrrp@1:zone-policy@1:content-inspection@3:webproxy@1:quagga@2:webgui@1:wanloadbalance@3:ipsec@3:firewall@4:conntrack-sync@1:cluster@1:system@4:qos@1:nat@3:dhcp-server@4:config-management@1" === */
/* Release version: VC6.3-2011.07.21 */
